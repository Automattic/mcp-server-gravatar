# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json
---
# Variables used in this pipeline are defined in `shared-pipeline-vars`, which is `source`'d before calling `buidkite-agent pipeline upload`

steps:
  - group: 'Code Quality Checks'
    key: quality-checks
    steps:
      - label: 'ğŸ•µï¸ Linting & Formatting'
        key: quality-check
        plugins: [$NVM_PLUGIN]
        command: |
          echo "--- ğŸ“¦ Installing dependencies"
          npm ci
          echo "--- ğŸ•µï¸ Running linting checks"
          npm run lint
          echo "--- ğŸ•µï¸ Running formatting checks"
          npm run format:check
        notify:
          - github_commit_status:
              context: Lint & Formatting Check

      - label: 'ğŸ” Type Checking'
        key: type-check
        plugins: [$NVM_PLUGIN]
        command: |
          echo "--- ğŸ“¦ Installing dependencies"
          npm ci
          echo "--- ğŸ” Running TypeScript type checking"
          npx tsc --noEmit
        notify:
          - github_commit_status:
              context: Type Checking

  - group: 'Tests'
    key: all-tests
    steps:
      - label: 'ğŸ§ª Unit Tests'
        key: unit-tests
        plugins: [$NVM_PLUGIN]
        command: |
          echo "--- ğŸ“¦ Installing dependencies"
          npm ci
          echo "--- ğŸ§ª Running unit tests"
          npm test -- --dir test/unit
        notify:
          - github_commit_status:
              context: Unit Tests

      - label: 'ğŸ”„ Integration Tests'
        key: integration-tests
        plugins: [$NVM_PLUGIN]
        command: |
          echo "--- ğŸ“¦ Installing dependencies"
          npm ci
          echo "--- ğŸ”„ Running integration tests"
          npm test -- --dir test/integration
        notify:
          - github_commit_status:
              context: Integration Tests

      - label: 'ğŸŒ End-to-End Tests'
        key: e2e-tests
        plugins: [$NVM_PLUGIN]
        command: |
          echo "--- ğŸ“¦ Installing dependencies"
          npm ci
          echo "--- ğŸŒ Running end-to-end tests"
          npm test -- --dir test/e2e
        notify:
          - github_commit_status:
              context: End-to-End Tests

  - label: 'ğŸ“Š Test Coverage'
    key: test-coverage
    depends_on: all-tests
    plugins: [$NVM_PLUGIN]
    command: |
      echo "--- ğŸ“¦ Installing dependencies"
      npm ci
      echo "--- ğŸ“Š Generating test coverage report"
      npm run test:coverage
    artifact_paths:
      - 'coverage/**/*'
    notify:
      - github_commit_status:
          context: Test Coverage

  - label: 'ğŸ“¦ Build Check'
    key: build
    depends_on: [quality-checks, all-tests]
    plugins: [$NVM_PLUGIN]
    command: |
      echo "--- ğŸ“¦ Installing dependencies"
      npm ci
      echo "--- ğŸ“¦ Building the project"
      npm run build
    notify:
      - github_commit_status:
          context: Build

  - label: 'ğŸ” MCP Inspector Test'
    key: inspector
    depends_on: build
    plugins: [$NVM_PLUGIN]
    command: |
      echo "--- ğŸ“¦ Installing dependencies"
      npm ci
      .buildkite/commands/test-run-inspector.sh
    notify:
      - github_commit_status:
          context: MCP Inspector Testing
