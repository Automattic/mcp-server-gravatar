# yaml-language-server: $schema=https://raw.githubusercontent.com/buildkite/pipeline-schema/main/schema.json
---
# Variables used in this pipeline are defined in `shared-pipeline-vars`, which is `source`'d before calling `buidkite-agent pipeline upload`

steps:
  - group: 'Code Quality Checks'
    key: quality-checks
    steps:
      - label: 'ğŸ•µï¸ Linting & Formatting'
        key: quality-check
        plugins: [$NVM_PLUGIN]
        command: |
          echo "--- ğŸ“¦ Installing dependencies"
          npm ci
          echo "--- ğŸ•µï¸ Running linting checks"
          npm run lint
          echo "--- ğŸ•µï¸ Running formatting checks"
          npm run format:check
        notify:
          - github_commit_status:
              context: Lint & Formatting Check

      - label: 'ğŸ” Type Checking'
        key: type-check
        plugins: [$NVM_PLUGIN]
        command: |
          echo "--- ğŸ“¦ Installing dependencies"
          npm ci
          echo "--- ğŸ” Running TypeScript type checking"
          npx tsc --noEmit
        notify:
          - github_commit_status:
              context: Type Checking

  - label: 'ğŸ§ª Tests'
    key: tests
    plugins: [$NVM_PLUGIN]
    command: |
      echo "--- ğŸ“¦ Installing dependencies"
      npm ci
      echo "--- ğŸ§ª Running all tests"
      npm test
    notify:
      - github_commit_status:
          context: Tests

  - label: 'ğŸ” MCP Server Build and Run'
    key: server-launch-test
    depends_on:
      - tests
      - quality-checks
    plugins: [$NVM_PLUGIN]
    command: |
      echo "--- ğŸ“¦ Installing dependencies"
      npm ci
      .buildkite/commands/test-run-server.sh
    notify:
      - github_commit_status:
          context: MCP Server
